(function(window, $)
{
	$(function()
	{
		var pz = PinchZoomer.get("pz1"),
			markerCtr = 0,
			mode = "add",
			pzHandler = new Hammer(pz.elem().get(0));
		
		pzHandler.on('tap', onTapHandler);
		
		$("#addMarkerButton").click(function()
									{
										mode = "add";
										$("#addText").css("visibility", "visible");
										$("#removeText").css("visibility", "hidden");
										TweenMax.set($("#addMarkerGroup"), {className:"span4 offset2 alert", alpha:1});
										TweenMax.set($("#removeMarkerGroup"), {className:"span4 alert alertOff", alpha:0.75});
										TweenMax.set($("#addMarkerButton"), {className:"btn btn-dark"});
										TweenMax.set($("#removeMarkerButton"), {className:"btn btn-secondary"});
									});
		
		$("#removeMarkerButton").click(function()
									   {
											mode = "remove";
											$("#addText").css("visibility", "hidden");
											$("#removeText").css("visibility", "visible");
											TweenMax.set($("#addMarkerGroup"), {className:"span4 offset2 alert alertOff", alpha:0.75});
											TweenMax.set($("#removeMarkerGroup"), {className:"span4 alert", alpha:1});
											TweenMax.set($("#addMarkerButton"), {className:"btn btn-secondary"});
											TweenMax.set($("#removeMarkerButton"), {className:"btn btn-dark"});
										});
		
		function onTapHandler(e)
		{
			if(mode == "add")
			{
				var clientRect = pz.elem().get(0).getBoundingClientRect(),
					elemPosX = clientRect.left,
					elemPosY = clientRect.top,
					center = e.center,
					x = (center.x - elemPosX) / (pz.baseZoom() * pz.zoom()),
					y = (center.y - elemPosY) / (pz.baseZoom() * pz.zoom()),
					//markerElem = $("<div id='marker" + markerCtr + "' class='marker' ><img src='assets/prod_marker.png' style='left:-15px; top:-15px; position:absolute; max-width:none' data-tooltip='Marker " + (markerCtr + 1) + "'/></div>"),
					markerElem = $("<img id='marker" + markerCtr + "' class='marker' src='assets/prod_marker.png' style='left:-15px; top:-15px; position:absolute; max-width:none' data-tooltip='Marker " + (markerCtr + 1) + "'/>"),
					markerElemHandler = new Hammer(markerElem.get(0));

				pz.addMarkers([new Marker(markerElem, {x:x, y:y, transformOrigin:"50% 50%"})]);
				markerElemHandler.on('tap', onMarkerHandler);
				
				markerCtr++;
			}
		}
		
		function onMarkerHandler(e)
		{
			if(mode == "remove")
			{
				var index = getMarkerIndex($(e.target).attr("id"));
				
				if(index >= 0)
				{
					pz.removeMarker(index, true);
				}
			}
		}
		
		function getMarkerIndex(id)
		{
			var markerIndex = -1,
				markers = pz.markers();
			
			for(var i = 0; i < markers.length; i++)
			{
				var marker = markers[i];
				
				if(marker.elem().attr("id") == id)
				{
					markerIndex = i;
					i = markers.length;
				}
			}
			
			return markerIndex;
		}
		
	});
	
}(window, jQuery)); 